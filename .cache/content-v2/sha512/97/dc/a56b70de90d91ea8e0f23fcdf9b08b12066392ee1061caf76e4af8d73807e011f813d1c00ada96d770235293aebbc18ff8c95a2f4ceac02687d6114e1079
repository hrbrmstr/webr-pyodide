var or=Object.create;var Ot=Object.defineProperty;var ir=Object.getOwnPropertyDescriptor;var lr=Object.getOwnPropertyNames;var pr=Object.getPrototypeOf,ur=Object.prototype.hasOwnProperty;var D=(r=>typeof require!="undefined"?require:typeof Proxy!="undefined"?new Proxy(r,{get:(e,t)=>(typeof require!="undefined"?require:e)[t]}):r)(function(r){if(typeof require!="undefined")return require.apply(this,arguments);throw new Error('Dynamic require of "'+r+'" is not supported')});var cr=(r,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of lr(e))!ur.call(r,s)&&s!==t&&Ot(r,s,{get:()=>e[s],enumerable:!(n=ir(e,s))||n.enumerable});return r};var Oe=(r,e,t)=>(t=r!=null?or(pr(r)):{},cr(e||!r||!r.__esModule?Ot(t,"default",{value:r,enumerable:!0}):t,r));var ct=(r,e,t)=>{if(!e.has(r))throw TypeError("Cannot "+t)};var a=(r,e,t)=>(ct(r,e,"read from private field"),t?t.call(r):e.get(r)),u=(r,e,t)=>{if(e.has(r))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(r):e.set(r,t)},c=(r,e,t,n)=>(ct(r,e,"write to private field"),n?n.call(r,t):e.set(r,t),t);var w=(r,e,t)=>(ct(r,e,"access private method"),t);var b=typeof process<"u"&&process.release&&process.release.name==="node",Rt;if(globalThis.document)Rt=r=>new Promise((e,t)=>{let n=document.createElement("script");n.src=r,n.onload=()=>e(),n.onerror=t,document.head.appendChild(n)});else if(globalThis.importScripts)Rt=async r=>{try{globalThis.importScripts(r)}catch(e){if(e instanceof TypeError)await Promise.resolve().then(()=>Oe(D(r)));else throw e}};else if(b)Rt=async r=>{let e=(await Promise.resolve().then(()=>Oe(D("path")))).default;await Promise.resolve().then(()=>Oe(D(e.resolve(r))))};else throw new Error("Cannot determine runtime environment");function V(){let r={resolve:t=>{},reject:t=>{},promise:null},e=new Promise((t,n)=>{r.resolve=t,r.reject=n});return r.promise=e,r}function Mt(r){return new Promise(e=>setTimeout(e,r))}function _(r,e,t,...n){return r===null||typeof r!="object"?r:e(r)?t(r,...n):Array.isArray(r)||ArrayBuffer.isView(r)?r.map(s=>_(s,e,t,...n)):Object.fromEntries(Object.entries(r).map(([s,o],l)=>[s,_(o,e,t,...n)]))}function Me(r,e){let t=new XMLHttpRequest;t.open("get",r,!0),t.onload=()=>{let n=new Worker(URL.createObjectURL(new Blob([t.responseText])));e(n)},t.send()}function H(r){if(b)return!1;let e=new URL(location.href),t=new URL(r,location.origin);return!(e.host===t.host&&e.port===t.port&&e.protocol===t.protocol)}var Rr=new WeakMap;function Dt(r,e){return Rr.set(r,e),r}var De=63;function Ae(){let r=Array.from({length:4},yr).join("-");if(r.length!==De)throw new Error("comlink internal error: UUID has the wrong length");return r}function yr(){let r=Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16),e=15-r.length;return e>0&&(r=Array.from({length:e},()=>0).join("")+r),r}function Ce(r,e){return At({type:"request",data:{uuid:Ae(),msg:r}},e)}function yt(r,e,t){return At({type:"response",data:{uuid:r,resp:e}},t)}function At(r,e){return e&&Dt(r,e),r}function Ct(r,e){return{type:"sync-request",data:{msg:r,reqData:e}}}var dr=new TextEncoder,mr=new TextDecoder("utf-8");function je(r){return dr.encode(JSON.stringify(r))}function Ie(r){return JSON.parse(mr.decode(r))}var hr=new TextEncoder;async function It(r,e,t){try{let{taskId:n,sizeBuffer:s,dataBuffer:o,signalBuffer:l}=e,p=je(t),y=p.length<=o.length;if(Atomics.store(s,0,p.length),Atomics.store(s,1,+y),!y){let[x,ae]=fr(r);o.set(hr.encode(x)),await jt(l,n),o=(await ae).dataBuffer}o.set(p),Atomics.store(s,1,1),await jt(l,n)}catch(n){console.warn(n)}}function fr(r){let e=Ae();return[e,new Promise(t=>{b?r.once("message",n=>{!n.id||n.id!==e||t(n)}):r.addEventListener("message",function n(s){!s.data||!s.data.id||s.data.id!==e||(r.removeEventListener("message",n),t(s.data))}),r.start&&r.start()})]}async function jt(r,e){let t=(e>>1)%32,n=1;for(;Atomics.compareExchange(r,t+1,0,e)!==0;)await Mt(n),n<32&&(n*=2);Atomics.or(r,0,1<<t),Atomics.notify(r,0)}var W,S,oe,dt,G=class{constructor(){u(this,oe);u(this,W,void 0);u(this,S,void 0);c(this,S,[]),c(this,W,[])}put(e){a(this,S).length||w(this,oe,dt).call(this),a(this,S).shift()(e)}async get(){return a(this,W).length||w(this,oe,dt).call(this),a(this,W).shift()}isEmpty(){return!a(this,W).length}isBlocked(){return!!a(this,S).length}get length(){return a(this,W).length-a(this,S).length}};W=new WeakMap,S=new WeakMap,oe=new WeakSet,dt=function(){a(this,W).push(new Promise(e=>{a(this,S).push(e)}))};function Nt(r){let e=new Error(r.obj.message);return e.name=r.obj.name,e.stack=r.obj.stack,e}function br(r){return r&&typeof r=="object"&&"payloadType"in r&&"obj"in r}function Fe(r){return br(r)&&r.payloadType==="ptr"}var $,X=class{constructor(){this.inputQueue=new G;this.outputQueue=new G;this.systemQueue=new G;u(this,$,new Map)}async read(){return await this.outputQueue.get()}async flush(){let e=[];for(;!this.outputQueue.isEmpty();)e.push(await this.read());return e}async readSystem(){return await this.systemQueue.get()}write(e){this.inputQueue.put(e)}async request(e,t){let n=Ce(e,t),{resolve:s,reject:o,promise:l}=V();return a(this,$).set(n.data.uuid,{resolve:s,reject:o}),this.write(n),l}resolveResponse(e){let t=e.data.uuid,n=a(this,$).get(t);if(n){let s=e.data.resp;a(this,$).delete(t),s.payloadType==="err"?n.reject(Nt(s)):n.resolve(s)}else console.warn("Can't find request.")}};$=new WeakMap;var wr=new TextDecoder("utf-8"),z,Q,ie,le,Z,Be=class{constructor(e,t,n=[]){u(this,z,!1);u(this,Q,void 0);u(this,ie,void 0);u(this,le,void 0);u(this,Z,void 0);this.syncifier=new mt;this.endpoint=e,this.msg=t,this.transfers=n,c(this,Q,!1)}scheduleSync(){if(!a(this,z))return c(this,z,!0),this.syncifier.scheduleTask(this),c(this,Z,this.doSync()),a(this,Z).next(),this}poll(){if(!a(this,z))throw new Error("Task not synchronously scheduled");let{done:e,value:t}=a(this,Z).next();return e?(c(this,Q,!0),c(this,ie,t),!0):!1}*doSync(){let{endpoint:e,msg:t,transfers:n}=this,s=new Int32Array(new SharedArrayBuffer(8)),o=this.signalBuffer,l=this.taskId,p=Ut(De),y=Ct(t,{sizeBuffer:s,dataBuffer:p,signalBuffer:o,taskId:l});if(e.postMessage(y,n),yield,Atomics.load(s,1)===0){let ae=wr.decode(p.slice(0,De));Pr(p);let ar=Atomics.load(s,0);p=Ut(ar),e.postMessage({id:ae,dataBuffer:p}),yield}let x=Atomics.load(s,0);return Ie(p.slice(0,x))}get result(){if(a(this,le))throw a(this,le);if(a(this,Q))return a(this,ie);throw new Error("Not ready.")}syncify(){return this.scheduleSync(),this.syncifier.syncifyTask(this),this.result}};z=new WeakMap,Q=new WeakMap,ie=new WeakMap,le=new WeakMap,Z=new WeakMap;var mt=class{constructor(){this.nextTaskId=new Int32Array([1]),this.signalBuffer=new Int32Array(new SharedArrayBuffer(32*4+4)),this.tasks=new Map}scheduleTask(e){e.taskId=this.nextTaskId[0],this.nextTaskId[0]+=2,e.signalBuffer=this.signalBuffer,this.tasks.set(e.taskId,e)}waitOnSignalBuffer(){for(;;)switch(Atomics.wait(this.signalBuffer,0,0,50)){case"ok":case"not-equal":return;case"timed-out":ht[0]!==0&&Ft();break;default:throw new Error("Unreachable")}}*tasksIdsToWakeup(){let e=Atomics.load(this.signalBuffer,0);for(let t=0;t<32;t++){let n=1<<t;e&n&&(Atomics.and(this.signalBuffer,0,~n),yield Atomics.exchange(this.signalBuffer,t+1,0))}}pollTasks(e){let t=!1;for(let n of this.tasksIdsToWakeup()){let s=this.tasks.get(n);if(!s)throw new Error(`Assertion error: unknown taskId ${n}.`);s.poll()&&(this.tasks.delete(n),s===e&&(t=!0))}return t}syncifyTask(e){for(;;)if(this.waitOnSignalBuffer(),this.pollTasks(e))return}},Le=[];function Ut(r){let e=Math.ceil(Math.log2(r));Le[e]||(Le[e]=[]);let t=Le[e].pop();return t?(t.fill(0),t):new Uint8Array(new SharedArrayBuffer(2**e))}function Pr(r){let e=Math.ceil(Math.log2(r.byteLength));Le[e].push(r)}var ht=new Int32Array(new ArrayBuffer(4)),Ft=()=>{throw ht[0]=0,new Error("Interrupted!")};function Lt(r){Ft=r}function Bt(r){ht=new Int32Array(r)}var i={};function qt(r){Object.keys(r).forEach(e=>i._free(r[e]))}b&&(globalThis.Worker=D("worker_threads").Worker);var K,qe,Jt,ue,pe=class extends X{constructor(t){super();u(this,qe);u(this,K,void 0);this.close=()=>{};u(this,ue,async(t,n)=>{if(!(!n||!n.type))switch(n.type){case"resolve":c(this,K,new Int32Array(n.data)),this.resolve();return;case"response":this.resolveResponse(n);return;case"system":this.systemQueue.put(n.data);return;default:this.outputQueue.put(n);return;case"sync-request":{let s=n,o=s.data.msg,l=s.data.reqData;switch(o.type){case"read":{let p=await this.inputQueue.get();await It(t,l,p);break}default:throw new TypeError(`Unsupported request type '${o.type}'.`)}return}case"request":throw new TypeError("Can't send messages of type 'request' from a worker. Please Use 'sync-request' instead.")}});let n=s=>{w(this,qe,Jt).call(this,s),this.close=()=>s.terminate();let o={type:"init",data:{config:t,channelType:O.SharedArrayBuffer}};s.postMessage(o)};if(H(t.baseUrl))Me(`${t.baseUrl}webr-worker.js`,s=>n(s));else{let s=new Worker(`${t.baseUrl}webr-worker.js`);n(s)}({resolve:this.resolve,promise:this.initialised}=V())}interrupt(){if(!a(this,K))throw new Error("Failed attempt to interrupt before initialising interruptBuffer");a(this,K)[0]=1}};K=new WeakMap,qe=new WeakSet,Jt=function(t){b?t.on("message",n=>{a(this,ue).call(this,t,n)}):t.onmessage=n=>a(this,ue).call(this,t,n.data)},ue=new WeakMap;var N,ce,U,Re,ft=class{constructor(){u(this,N,void 0);u(this,ce,()=>0);u(this,U,new Int32Array(new SharedArrayBuffer(4)));u(this,Re,()=>{});c(this,N,b?D("worker_threads").parentPort:globalThis),Bt(a(this,U).buffer),Lt(()=>this.handleInterrupt())}resolve(){this.write({type:"resolve",data:a(this,U).buffer})}write(e,t){a(this,N).postMessage(e,t)}writeSystem(e,t){a(this,N).postMessage({type:"system",data:e},t)}read(){let e={type:"read"};return new Be(a(this,N),e).syncify()}inputOrDispatch(){for(;;){let e=this.read();if(e.type==="stdin")return i.allocateUTF8(e.data);a(this,ce).call(this,e)}}run(e){i.callMain(e)}setInterrupt(e){c(this,Re,e)}handleInterrupt(){a(this,U)[0]!==0&&(a(this,U)[0]=0,a(this,Re).call(this))}setDispatchHandler(e){c(this,ce,e)}};N=new WeakMap,ce=new WeakMap,U=new WeakMap,Re=new WeakMap;b&&(globalThis.Worker=D("worker_threads").Worker);var Y,F,ee,Je,Vt,Ve,Ht,He,Gt,de,ye=class extends X{constructor(t){super();u(this,Je);u(this,Ve);u(this,He);this.close=()=>{};u(this,Y,new Map);u(this,F,void 0);u(this,ee,!1);u(this,de,async(t,n)=>{if(!(!n||!n.type))switch(n.type){case"resolve":this.resolve();return;case"response":this.resolveResponse(n);return;case"system":this.systemQueue.put(n.data);return;default:this.outputQueue.put(n);return;case"sync-request":{let s=n.data;a(this,Y).set(s.data.uuid,s.data.msg);return}case"request":throw new TypeError("Can't send messages of type 'request' from a worker.Use service worker fetch request instead.")}});let n=s=>{w(this,He,Gt).call(this,s),this.close=()=>s.terminate(),w(this,Je,Vt).call(this,`${t.serviceWorkerUrl}webr-serviceworker.js`).then(o=>{let l={type:"init",data:{config:t,channelType:O.ServiceWorker,clientId:o,location:window.location.href}};s.postMessage(l)})};if(H(t.serviceWorkerUrl))Me(`${t.serviceWorkerUrl}webr-worker.js`,s=>n(s));else{let s=new Worker(`${t.serviceWorkerUrl}webr-worker.js`);n(s)}({resolve:this.resolve,promise:this.initialised}=V())}activeRegistration(){var t;if(!((t=a(this,F))!=null&&t.active))throw new Error("Attempted to obtain a non-existent active registration.");return a(this,F).active}interrupt(){c(this,ee,!0)}};Y=new WeakMap,F=new WeakMap,ee=new WeakMap,Je=new WeakSet,Vt=async function(t){c(this,F,await navigator.serviceWorker.register(t)),await navigator.serviceWorker.ready,window.addEventListener("beforeunload",()=>{var s;(s=a(this,F))==null||s.unregister()});let n=await new Promise(s=>{navigator.serviceWorker.addEventListener("message",function o(l){l.data.type==="registration-successful"&&(navigator.serviceWorker.removeEventListener("message",o),s(l.data.clientId))}),this.activeRegistration().postMessage({type:"register-client-main"})});return navigator.serviceWorker.addEventListener("message",s=>{w(this,Ve,Ht).call(this,s)}),n},Ve=new WeakSet,Ht=async function(t){if(t.data.type==="request"){let n=t.data.data,s=a(this,Y).get(n);if(!s)throw new Error("Request not found during service worker XHR request");switch(a(this,Y).delete(n),s.type){case"read":{let o=await this.inputQueue.get();this.activeRegistration().postMessage({type:"wasm-webr-fetch-response",uuid:n,response:yt(n,o)});break}case"interrupt":{let o=a(this,ee);this.activeRegistration().postMessage({type:"wasm-webr-fetch-response",uuid:n,response:yt(n,o)}),c(this,ee,!1);break}default:throw new TypeError(`Unsupported request type '${s.type}'.`)}return}},He=new WeakSet,Gt=function(t){b?t.on("message",n=>{a(this,de).call(this,t,n)}):t.onmessage=n=>a(this,de).call(this,t,n.data)},de=new WeakMap;var te,me,he,fe,be,bt=class{constructor(e){u(this,te,void 0);u(this,me,void 0);u(this,he,void 0);u(this,fe,()=>0);u(this,be,()=>{});this.onMessageFromMainThread=()=>{};if(!e.clientId||!e.location)throw Error("Can't start service worker channel");c(this,me,e.clientId),c(this,he,e.location),c(this,te,b?D("worker_threads").parentPort:globalThis)}resolve(){this.write({type:"resolve"})}write(e,t){a(this,te).postMessage(e,t)}writeSystem(e,t){a(this,te).postMessage({type:"system",data:e},t)}syncRequest(e){let t=Ce(e);this.write({type:"sync-request",data:t});let n=0;for(;;)try{let s=new URL("__wasm__/webr-fetch-request/",a(this,he)),o=new XMLHttpRequest;o.timeout=6e4,o.responseType="arraybuffer",o.open("POST",s,!1);let l={clientId:a(this,me),uuid:t.data.uuid};return o.send(je(l)),Ie(new Uint8Array(o.response))}catch(s){if(s instanceof DOMException&&n++<1e3)console.log("Service worker request failed - resending request");else throw s}}read(){return this.syncRequest({type:"read"}).data.resp}inputOrDispatch(){for(;;){let e=this.read();if(e.type==="stdin")return i.allocateUTF8(e.data);a(this,fe).call(this,e)}}run(e){i.callMain(e)}setInterrupt(e){c(this,be,e)}handleInterrupt(){this.syncRequest({type:"interrupt"}).data.resp&&a(this,be).call(this)}setDispatchHandler(e){c(this,fe,e)}};te=new WeakMap,me=new WeakMap,he=new WeakMap,fe=new WeakMap,be=new WeakMap;var O={Automatic:0,SharedArrayBuffer:1,ServiceWorker:2};function $t(r){switch(r.channelType){case O.SharedArrayBuffer:return new pe(r);case O.ServiceWorker:return new ye(r);case O.Automatic:default:if(typeof SharedArrayBuffer<"u")return new pe(r);if("serviceWorker"in navigator&&!H(r.serviceWorkerUrl))return new ye(r);throw new Error("Can't initialise main thread communication channel")}}var Xt=b?__dirname+"/":"https://webr.r-wasm.org/main/",zt="https://repo.r-wasm.org";function M(r){return r&&(typeof r=="object"||typeof r=="function")&&"payloadType"in r&&Fe(r._payload)}function Qt(r){var e;return Boolean(M(r)&&((e=r._payload.obj.methods)==null?void 0:e.includes("exec")))}var d={null:0,symbol:1,pairlist:2,closure:3,environment:4,promise:5,call:6,special:7,builtin:8,string:9,logical:10,integer:13,double:14,complex:15,character:16,dots:17,any:18,list:19,expression:20,bytecode:21,pointer:22,weakref:23,raw:24,s4:25,new:30,free:31,function:99};function gt(r){return r&&typeof r=="object"&&Object.keys(d).includes(r.type)}function wt(r){return r&&typeof r=="object"&&"re"in r&&"im"in r}function Ge(r){return i._Rf_protect(k(r)),r}function P(r,e){return i._Rf_protect(k(r)),++e.n,r}function Zt(r){let e=i._malloc(4);return i._R_ProtectWithIndex(k(r),e),{loc:i.getValue(e,"i32"),ptr:e}}function Kt(r){i._Rf_unprotect(1),i._free(r.ptr)}function Yt(r,e){return i._R_Reprotect(k(r),e.loc),r}function T(r){i._Rf_unprotect(r)}function Pt(r,e,t){i._Rf_defineVar(k(e),k(t),k(r))}function er(r,e){let t={},n={n:0};try{let s=new we(e);P(s,n),t.code=i.allocateUTF8(r);let o=i._R_ParseEvalString(t.code,s.ptr);return R.wrap(o)}finally{qt(t),T(n.n)}}function ge(r,e){return i.LDSO.loadedLibsByName["/usr/lib/R/library/webr/libs/webr.so"].module.ffi_safe_eval(k(r),k(e))}function k(r){return Er(r)?r.ptr:r}function J(r,e){if(i._TYPEOF(r.ptr)!==d[e])throw new Error(`Unexpected object type "${r.type()}" when expecting type "${e}"`)}function xr(r){if(gt(r))return new(tr(d[r.type]))(r);if(r&&typeof r=="object"&&"type"in r&&r.type==="null")return new Qe;if(r===null)return new B({type:"logical",names:null,values:[null]});if(typeof r=="boolean")return new B(r);if(typeof r=="number")return new Pe(r);if(typeof r=="string")return new A(r);if(wt(r))return new ve(r);if(Array.isArray(r))return Tr(r);throw new Error("Robj construction for this JS object is not yet supported")}function Tr(r){let e={n:0};try{let t=new q([new C("c"),...r]);return P(t,e),t.eval()}finally{T(e.n)}}var g=class{constructor(e){this.ptr=e}type(){let e=i._TYPEOF(this.ptr);return Object.keys(d).find(n=>d[n]===e)}},ne,$e,L=class extends g{constructor(t){if(!(t instanceof g))return xr(t);super(t.ptr);u(this,ne)}static wrap(t){let n=i._TYPEOF(t);return new(tr(n))(new g(t))}get[Symbol.toStringTag](){return`RObject:${this.type()}`}static getPersistentObject(t){return v[t]}getPropertyValue(t){return this[t]}inspect(){er(".Internal(inspect(x))",{x:this})}isNull(){return i._TYPEOF(this.ptr)===d.null}isUnbound(){return this.ptr===v.unboundValue.ptr}attrs(){return se.wrap(i._ATTRIB(this.ptr))}setNames(t){let n;if(t===null)n=v.null;else if(Array.isArray(t)&&t.every(s=>typeof s=="string"||s===null))n=new A(t);else throw new Error("Argument to setNames must be null or an Array of strings or null");return i._Rf_setAttrib(this.ptr,v.namesSymbol.ptr,n.ptr),this}names(){let t=A.wrap(i._Rf_getAttrib(this.ptr,v.namesSymbol.ptr));return t.isNull()?null:t.toArray()}includes(t){let n=this.names();return n&&n.includes(t)}toJs(t={depth:0},n=1){throw new Error("This R object cannot be converted to JS")}subset(t){return w(this,ne,$e).call(this,t,v.bracketSymbol.ptr)}get(t){return w(this,ne,$e).call(this,t,v.bracket2Symbol.ptr)}getDollar(t){return w(this,ne,$e).call(this,t,v.dollarSymbol.ptr)}pluck(...t){let n=Zt(v.null);try{let s=(l,p)=>{let y=l.get(p);return Yt(y,n)},o=t.reduce(s,this);return o.isNull()?void 0:o}finally{Kt(n)}}set(t,n){let s={n:0};try{let o=new L(t);P(o,s);let l=new L(n);P(l,s);let p=new C("[[<-"),y=i._Rf_lang4(p.ptr,this.ptr,o.ptr,l.ptr);return P(y,s),L.wrap(ge(y,v.baseEnv))}finally{T(s.n)}}static getMethods(t){let n=new Set,s=t;do Object.getOwnPropertyNames(s).map(o=>n.add(o));while(s=Object.getPrototypeOf(s));return[...n.keys()].filter(o=>typeof t[o]=="function")}},R=L;ne=new WeakSet,$e=function(t,n){let s={n:0};try{let o=new L(t);P(o,s);let l=i._Rf_lang3(n,this.ptr,o.ptr);return P(l,s),L.wrap(ge(l,v.baseEnv))}finally{T(s.n)}};var Qe=class extends R{constructor(){return super(new g(i.getValue(i._R_NilValue,"*"))),this}toJs(){return{type:"null"}}},C=class extends R{constructor(e){if(e instanceof g){J(e,"symbol"),super(e);return}let t=i.allocateUTF8(e);try{super(new g(i._Rf_install(t)))}finally{i._free(t)}}toJs(){let e=this.toObject();return{type:"symbol",printname:e.printname,symvalue:e.symvalue,internal:e.internal}}toObject(){return{printname:this.printname().isUnbound()?null:this.printname().toString(),symvalue:this.symvalue().isUnbound()?null:this.symvalue().ptr,internal:this.internal().isNull()?null:this.internal().ptr}}toString(){return this.printname().toString()}printname(){return xe.wrap(i._PRINTNAME(this.ptr))}symvalue(){return R.wrap(i._SYMVALUE(this.ptr))}internal(){return R.wrap(i._INTERNAL(this.ptr))}},se=class extends R{constructor(e){if(e instanceof g)return J(e,"pairlist"),super(e),this;let t={n:0};try{let{names:n,values:s}=Te(e),o=se.wrap(i._Rf_allocList(s.length));P(o,t);for(let[l,p]=[0,o];!p.isNull();[l,p]=[l+1,p.cdr()])p.setcar(new R(s[l]));o.setNames(n),super(o)}finally{T(t.n)}}get length(){return this.toArray().length}toArray(e={depth:1}){return this.toJs(e).values}toObject({allowDuplicateKey:e=!0,allowEmptyKey:t=!1,depth:n=1}={}){let s=this.entries({depth:n}),o=s.map(([l,p])=>l);if(!e&&new Set(o).size!==o.length)throw new Error("Duplicate key when converting pairlist without allowDuplicateKey enabled");if(!t&&o.some(l=>!l))throw new Error("Empty or null key when converting pairlist without allowEmptyKey enabled");return Object.fromEntries(s.filter((l,p)=>s.findIndex(y=>y[0]===l[0])===p))}entries(e={depth:1}){let t=this.toJs(e);return t.values.map((n,s)=>[t.names?t.names[s]:null,n])}toJs(e={depth:0},t=1){let n=[],s=!1,o=[];for(let p=this;!p.isNull();p=p.cdr()){let y=p.tag();y.isNull()?n.push(""):(s=!0,n.push(y.toString())),e.depth&&t>=e.depth?o.push(p.car()):o.push(p.car().toJs(e,t+1))}return{type:"pairlist",names:s?n:null,values:o}}includes(e){return e in this.toObject()}setcar(e){i._SETCAR(this.ptr,e.ptr)}car(){return R.wrap(i._CAR(this.ptr))}cdr(){return R.wrap(i._CDR(this.ptr))}tag(){return R.wrap(i._TAG(this.ptr))}},q=class extends R{constructor(e){if(e instanceof g)return J(e,"call"),super(e),this;let t={n:0};try{let{values:n}=Te(e),s=n.map(l=>P(new R(l),t)),o=q.wrap(i._Rf_allocVector(d.call,n.length));P(o,t);for(let[l,p]=[0,o];!p.isNull();[l,p]=[l+1,p.cdr()])p.setcar(s[l]);super(o)}finally{T(t.n)}}setcar(e){i._SETCAR(this.ptr,e.ptr)}car(){return R.wrap(i._CAR(this.ptr))}cdr(){return R.wrap(i._CDR(this.ptr))}eval(){return R.wrap(ge(this.ptr,v.baseEnv))}},vt=class extends R{constructor(e){if(e instanceof g)return J(e,"list"),super(e),this;let t={n:0};try{let{names:n,values:s}=Te(e),o=i._Rf_allocVector(d.list,s.length);P(o,t),s.forEach((l,p)=>{i._SET_VECTOR_ELT(o,p,new R(l).ptr)}),R.wrap(o).setNames(n),super(new g(o))}finally{T(t.n)}}get length(){return i._LENGTH(this.ptr)}toArray(e={depth:1}){return this.toJs(e).values}toObject({allowDuplicateKey:e=!0,allowEmptyKey:t=!1,depth:n=1}={}){let s=this.entries({depth:n}),o=s.map(([l,p])=>l);if(!e&&new Set(o).size!==o.length)throw new Error("Duplicate key when converting list without allowDuplicateKey enabled");if(!t&&o.some(l=>!l))throw new Error("Empty or null key when converting list without allowEmptyKey enabled");return Object.fromEntries(s.filter((l,p)=>s.findIndex(y=>y[0]===l[0])===p))}entries(e={depth:1}){let t=this.toJs(e);return t.values.map((n,s)=>[t.names?t.names[s]:null,n])}toJs(e={depth:0},t=1){return{type:"list",names:this.names(),values:[...Array(this.length).keys()].map(n=>e.depth&&t>=e.depth?this.get(n+1):this.get(n+1).toJs(e,t+1))}}},re=class extends R{exec(...e){let t={n:0};try{let n=new q([this,...e]);return P(n,t),n.eval()}finally{T(t.n)}}},xe=class extends R{constructor(e){if(e instanceof g){J(e,"string"),super(e);return}let t=i.allocateUTF8(e);try{super(new g(i._Rf_mkChar(t)))}finally{i._free(t)}}toString(){return i.UTF8ToString(i._R_CHAR(this.ptr))}toJs(){return{type:"string",value:this.toString()}}},we=class extends R{constructor(e={}){if(e instanceof g)return J(e,"environment"),super(e),this;let t=0;try{let{names:n,values:s}=Te(e),o=Ge(i._R_NewEnv(v.globalEnv.ptr,0,0));++t,s.forEach((l,p)=>{let y=n?n[p]:null;if(!y)throw new Error("Can't create object in new environment with empty symbol name");let x=new C(y),ae=Ge(new R(l));try{Pt(o,x,ae)}finally{T(1)}}),super(new g(o))}finally{T(t)}}ls(e=!1,t=!0){return A.wrap(i._R_lsInternal3(this.ptr,Number(e),Number(t))).toArray()}bind(e,t){let n=new C(e),s=Ge(new R(t));try{Pt(this,n,s)}finally{T(1)}}names(){return this.ls(!0,!0)}frame(){return R.wrap(i._FRAME(this.ptr))}subset(e){if(typeof e=="number")throw new Error("Object of type environment is not subsettable");return this.getDollar(e)}toObject({depth:e=0}={}){let t=this.names();return Object.fromEntries([...Array(t.length).keys()].map(n=>[t[n],this.getDollar(t[n]).toJs({depth:e})]))}toJs(e={depth:0},t=1){let n=this.names(),s=[...Array(n.length).keys()].map(o=>e.depth&&t>=e.depth?this.getDollar(n[o]):this.getDollar(n[o]).toJs(e,t+1));return{type:"environment",names:n,values:s}}},j=class extends R{constructor(e,t,n){if(e instanceof g)return J(e,t),super(e),this;let s={n:0};try{let{names:o,values:l}=Te(e),p=i._Rf_allocVector(d[t],l.length);P(p,s),l.forEach(n(p)),R.wrap(p).setNames(o),super(new g(p))}finally{T(s.n)}}get length(){return i._LENGTH(this.ptr)}get(e){return super.get(e)}subset(e){return super.subset(e)}getDollar(e){throw new Error("$ operator is invalid for atomic vectors")}detectMissing(){let e={n:0};try{let t=i._Rf_lang2(new C("is.na").ptr,this.ptr);P(t,e);let n=B.wrap(ge(t,v.baseEnv));P(n,e);let s=n.toTypedArray();return Array.from(s).map(o=>Boolean(o))}finally{T(e.n)}}toArray(){let e=this.toTypedArray();return this.detectMissing().map((t,n)=>t?null:e[n])}toObject({allowDuplicateKey:e=!0,allowEmptyKey:t=!1}={}){let n=this.entries(),s=n.map(([o,l])=>o);if(!e&&new Set(s).size!==s.length)throw new Error("Duplicate key when converting atomic vector without allowDuplicateKey enabled");if(!t&&s.some(o=>!o))throw new Error("Empty or null key when converting atomic vector without allowEmptyKey enabled");return Object.fromEntries(n.filter((o,l)=>n.findIndex(p=>p[0]===o[0])===l))}entries(){let e=this.toArray(),t=this.names();return e.map((n,s)=>[t?t[s]:null,n])}toJs(){return{type:this.type(),names:this.names(),values:this.toArray()}}},Ze,xt=class extends j{constructor(e){super(e,"logical",a(xt,Ze))}getBoolean(e){return this.get(e).toArray()[0]}toBoolean(){if(this.length!==1)throw new Error("Can't convert atomic vector of length > 1 to a scalar JS value");let e=this.getBoolean(1);if(e===null)throw new Error("Can't convert missing value `NA` to a JS boolean");return e}toTypedArray(){return new Int32Array(i.HEAP32.subarray(i._LOGICAL(this.ptr)/4,i._LOGICAL(this.ptr)/4+this.length))}toArray(){let e=this.toTypedArray();return this.detectMissing().map((t,n)=>t?null:Boolean(e[n]))}},B=xt;Ze=new WeakMap,u(B,Ze,e=>{let t=i._LOGICAL(e),n=i.getValue(i._R_NaInt,"i32");return(s,o)=>{i.setValue(t+4*o,s===null?n:Boolean(s),"i32")}});var Ke,Tt=class extends j{constructor(e){super(e,"integer",a(Tt,Ke))}getNumber(e){return this.get(e).toArray()[0]}toNumber(){if(this.length!==1)throw new Error("Can't convert atomic vector of length > 1 to a scalar JS value");let e=this.getNumber(1);if(e===null)throw new Error("Can't convert missing value `NA` to a JS number");return e}toTypedArray(){return new Int32Array(i.HEAP32.subarray(i._INTEGER(this.ptr)/4,i._INTEGER(this.ptr)/4+this.length))}},Xe=Tt;Ke=new WeakMap,u(Xe,Ke,e=>{let t=i._INTEGER(e),n=i.getValue(i._R_NaInt,"i32");return(s,o)=>{i.setValue(t+4*o,s===null?n:Math.round(Number(s)),"i32")}});var Ye,Et=class extends j{constructor(e){super(e,"double",a(Et,Ye))}getNumber(e){return this.get(e).toArray()[0]}toNumber(){if(this.length!==1)throw new Error("Can't convert atomic vector of length > 1 to a scalar JS value");let e=this.getNumber(1);if(e===null)throw new Error("Can't convert missing value `NA` to a JS number");return e}toTypedArray(){return new Float64Array(i.HEAPF64.subarray(i._REAL(this.ptr)/8,i._REAL(this.ptr)/8+this.length))}},Pe=Et;Ye=new WeakMap,u(Pe,Ye,e=>{let t=i._REAL(e),n=i.getValue(i._R_NaReal,"double");return(s,o)=>{i.setValue(t+8*o,s===null?n:s,"double")}});var et,_t=class extends j{constructor(e){super(e,"complex",a(_t,et))}getComplex(e){return this.get(e).toArray()[0]}toComplex(){if(this.length!==1)throw new Error("Can't convert atomic vector of length > 1 to a scalar JS value");let e=this.getComplex(1);if(e===null)throw new Error("Can't convert missing value `NA` to a JS object");return e}toTypedArray(){return new Float64Array(i.HEAPF64.subarray(i._COMPLEX(this.ptr)/8,i._COMPLEX(this.ptr)/8+2*this.length))}toArray(){let e=this.toTypedArray();return this.detectMissing().map((t,n)=>t?null:{re:e[2*n],im:e[2*n+1]})}},ve=_t;et=new WeakMap,u(ve,et,e=>{let t=i._COMPLEX(e),n=i.getValue(i._R_NaReal,"double");return(s,o)=>{i.setValue(t+8*(2*o),s===null?n:s.re,"double"),i.setValue(t+8*(2*o+1),s===null?n:s.im,"double")}});var tt,kt=class extends j{constructor(e){super(e,"character",a(kt,tt))}getString(e){return this.get(e).toArray()[0]}toString(){if(this.length!==1)throw new Error("Can't convert atomic vector of length > 1 to a scalar JS value");let e=this.getString(1);if(e===null)throw new Error("Can't convert missing value `NA` to a JS string");return e}toTypedArray(){return new Uint32Array(i.HEAPU32.subarray(i._STRING_PTR(this.ptr)/4,i._STRING_PTR(this.ptr)/4+this.length))}toArray(){return this.detectMissing().map((e,t)=>e?null:i.UTF8ToString(i._R_CHAR(i._STRING_ELT(this.ptr,t))))}},A=kt;tt=new WeakMap,u(A,tt,e=>(t,n)=>{t===null?i._SET_STRING_ELT(e,n,v.naString.ptr):i._SET_STRING_ELT(e,n,new xe(t).ptr)});var rt,Wt=class extends j{constructor(e){super(e,"raw",a(Wt,rt))}getNumber(e){return this.get(e).toArray()[0]}toNumber(){if(this.length!==1)throw new Error("Can't convert atomic vector of length > 1 to a scalar JS value");let e=this.getNumber(1);if(e===null)throw new Error("Can't convert missing value `NA` to a JS number");return e}toTypedArray(){return new Uint8Array(i.HEAPU8.subarray(i._RAW(this.ptr),i._RAW(this.ptr)+this.length))}},ze=Wt;rt=new WeakMap,u(ze,rt,e=>{let t=i._RAW(e);return(n,s)=>{i.setValue(t+s,Number(n),"i8")}});function Te(r){return gt(r)?r:Array.isArray(r)?{names:null,values:r}:r&&typeof r=="object"&&!wt(r)?{names:Object.keys(r),values:Object.values(r)}:{names:null,values:[r]}}function tr(r){let e={[d.null]:Qe,[d.symbol]:C,[d.pairlist]:se,[d.closure]:re,[d.environment]:we,[d.call]:q,[d.special]:re,[d.builtin]:re,[d.string]:xe,[d.logical]:B,[d.integer]:Xe,[d.double]:Pe,[d.complex]:ve,[d.character]:A,[d.list]:vt,[d.raw]:ze,[d.function]:re};return r in e?e[r]:R}function Er(r){return r instanceof R}var v;function kr(){}function Wr(r,e){return async function*(){let t={type:"callRObjectMethod",data:{payload:e._payload,prop:"getPropertyValue",args:[{payloadType:"raw",obj:"length"}],shelter:void 0}},n=await r.request(t);if(typeof n.obj!="number")throw new Error("Cannot iterate over object, unexpected type for length property.");for(let s=1;s<=n.obj;s++)yield e.get(s)}}function rr(r,e,t){return async(...n)=>{let s=n.map(p=>M(p)?p._payload:{obj:_(p,M,y=>y._payload),payloadType:"raw"}),o={type:"callRObjectMethod",data:{payload:t,prop:e,args:s}},l=await r.request(o);switch(l.payloadType){case"ptr":return I(r,l);case"raw":return _(l,Fe,(y,x)=>I(x,y),r).obj}}}async function Sr(r,e,t,n){let s={type:"newRObject",data:{objType:e,obj:_(n,M,l=>l._payload),shelter:t}},o=await r.request(s);switch(o.payloadType){case"raw":throw new Error("Unexpected raw payload type returned from newRObject");case"ptr":return I(r,o)}}function I(r,e){var n;let t=new Proxy((n=e.obj.methods)!=null&&n.includes("exec")?Object.assign(kr,{...e}):e,{get:(s,o)=>{var l;if(o==="_payload")return e;if(o===Symbol.asyncIterator)return Wr(r,t);if((l=e.obj.methods)!=null&&l.includes(o.toString()))return rr(r,o.toString(),e)},apply:async(s,o,l)=>{let p=await I(r,e).exec(...l);return Qt(p)?p:p.toJs()}});return t}function E(r,e,t){return new Proxy(R,{construct:(n,s)=>Sr(r,t,e,...s),get:(n,s)=>rr(r,s.toString())})}var Ee,_e,ke,We,nt,st,at,ot,it,nr,St=class{constructor(e={},t={REnv:{R_HOME:"/usr/lib/R",R_ENABLE_JIT:"0",R_DEFAULT_DEVICE:"canvas"}}){u(this,it);u(this,Ee,void 0);u(this,_e,void 0);u(this,ke,void 0);u(this,We,void 0);u(this,nt,e=>{console.log(e)});u(this,st,e=>{console.error(e)});u(this,at,e=>{let t=prompt(e);t&&this.stdin(`${t}
`)});u(this,ot,e=>{if(b)throw new Error("Plotting with HTML canvas is not yet supported under Node");Function(`this.getContext('2d').${e}`).bind(this.canvas)()});this.webR=new lt(t),b||(this.canvas=document.createElement("canvas"),this.canvas.setAttribute("width","1008"),this.canvas.setAttribute("height","1008")),c(this,Ee,e.stdout||a(this,nt)),c(this,_e,e.stderr||a(this,st)),c(this,ke,e.prompt||a(this,at)),c(this,We,e.canvasExec||a(this,ot))}stdin(e){this.webR.writeConsole(e)}interrupt(){this.webR.interrupt()}run(){w(this,it,nr).call(this)}};Ee=new WeakMap,_e=new WeakMap,ke=new WeakMap,We=new WeakMap,nt=new WeakMap,st=new WeakMap,at=new WeakMap,ot=new WeakMap,it=new WeakSet,nr=async function(){for(;;){let e=await this.webR.read();switch(e.type){case"stdout":a(this,Ee).call(this,e.data);break;case"stderr":a(this,_e).call(this,e.data);break;case"prompt":a(this,ke).call(this,e.data);break;case"canvasExec":a(this,We).call(this,e.data);break;default:console.warn(`Unhandled output type for webR Console: ${e.type}.`)}}};var Or={R_HOME:"/usr/lib/R",R_ENABLE_JIT:"0"},Mr={RArgs:[],REnv:Or,baseUrl:Xt,serviceWorkerUrl:"",repoUrl:zt,homedir:"/home/web_user",interactive:!0,channelType:O.Automatic},f,ut,sr,lt=class{constructor(e={}){u(this,ut);u(this,f,void 0);this.FS={lookupPath:async e=>{let t={type:"lookupPath",data:{path:e}};return(await a(this,f).request(t)).obj},mkdir:async e=>{let t={type:"mkdir",data:{path:e}};return(await a(this,f).request(t)).obj},readFile:async(e,t)=>{let n={type:"readFile",data:{path:e,flags:t}};return(await a(this,f).request(n)).obj},rmdir:async e=>{let t={type:"rmdir",data:{path:e}};await a(this,f).request(t)},writeFile:async(e,t,n)=>{let s={type:"writeFile",data:{path:e,data:t,flags:n}};await a(this,f).request(s)},unlink:async e=>{let t={type:"unlink",data:{path:e}};await a(this,f).request(t)}};let t=Object.assign(Mr,e);c(this,f,$t(t)),this.objs={},this.Shelter=Dr(a(this,f))}async init(){let e=await a(this,f).initialised;return this.globalShelter=await new this.Shelter,this.RObject=this.globalShelter.RObject,this.RLogical=this.globalShelter.RLogical,this.RInteger=this.globalShelter.RInteger,this.RDouble=this.globalShelter.RDouble,this.RComplex=this.globalShelter.RComplex,this.RCharacter=this.globalShelter.RCharacter,this.RRaw=this.globalShelter.RRaw,this.RList=this.globalShelter.RList,this.RPairlist=this.globalShelter.RPairlist,this.REnvironment=this.globalShelter.REnvironment,this.RSymbol=this.globalShelter.RSymbol,this.RString=this.globalShelter.RString,this.RCall=this.globalShelter.RCall,this.objs={baseEnv:await this.RObject.getPersistentObject("baseEnv"),globalEnv:await this.RObject.getPersistentObject("globalEnv"),null:await this.RObject.getPersistentObject("null"),true:await this.RObject.getPersistentObject("true"),false:await this.RObject.getPersistentObject("false"),na:await this.RObject.getPersistentObject("na")},w(this,ut,sr).call(this),e}close(){a(this,f).close()}async read(){return await a(this,f).read()}async flush(){return await a(this,f).flush()}write(e){a(this,f).write(e)}writeConsole(e){this.write({type:"stdin",data:e+`
`})}interrupt(){a(this,f).interrupt()}async installPackages(e){for(let t of e){let n={type:"installPackage",data:{name:t}};await a(this,f).request(n)}}async destroy(e){await this.globalShelter.destroy(e)}async evalR(e,t){return this.globalShelter.evalR(e,t)}async evalRVoid(e,t){return this.evalRRaw(e,"void",t)}async evalRBoolean(e,t){return this.evalRRaw(e,"boolean",t)}async evalRNumber(e,t){return this.evalRRaw(e,"number",t)}async evalRString(e,t){return this.evalRRaw(e,"string",t)}async evalRRaw(e,t,n={}){let s=_(n,M,p=>p._payload),o={type:"evalRRaw",data:{code:e,options:s,outputType:t}},l=await a(this,f).request(o);switch(l.payloadType){case"raw":return l.obj;case"ptr":throw new Error("Unexpected ptr payload type returned from evalRVoid")}}async invokeWasmFunction(e,...t){let n={type:"invokeWasmFunction",data:{ptr:e,args:t}};return(await a(this,f).request(n)).obj}};f=new WeakMap,ut=new WeakSet,sr=async function(){for(;;){let e=await a(this,f).readSystem();switch(e.type){case"setTimeoutWasm":setTimeout((t,n)=>{this.invokeWasmFunction(t,...n)},e.data.delay,e.data.ptr,e.data.args);break;default:throw new Error("Unknown system message type `"+e.type+"`")}}};var h,m,Se,pt=class{constructor(e){u(this,h,"");u(this,m,void 0);u(this,Se,!1);c(this,m,e)}async init(){if(a(this,Se))return;let e={type:"newShelter"},t=await a(this,m).request(e);c(this,h,t.obj),this.RObject=E(a(this,m),a(this,h),"object"),this.RLogical=E(a(this,m),a(this,h),"logical"),this.RInteger=E(a(this,m),a(this,h),"integer"),this.RDouble=E(a(this,m),a(this,h),"double"),this.RComplex=E(a(this,m),a(this,h),"complex"),this.RCharacter=E(a(this,m),a(this,h),"character"),this.RRaw=E(a(this,m),a(this,h),"raw"),this.RList=E(a(this,m),a(this,h),"list"),this.RPairlist=E(a(this,m),a(this,h),"pairlist"),this.REnvironment=E(a(this,m),a(this,h),"environment"),this.RSymbol=E(a(this,m),a(this,h),"symbol"),this.RString=E(a(this,m),a(this,h),"string"),this.RCall=E(a(this,m),a(this,h),"call"),c(this,Se,!0)}async purge(){let e={type:"shelterPurge",data:a(this,h)};await a(this,m).request(e)}async destroy(e){let t={type:"shelterDestroy",data:{id:a(this,h),obj:e._payload}};await a(this,m).request(t)}async size(){let e={type:"shelterSize",data:a(this,h)};return(await a(this,m).request(e)).obj}async evalR(e,t={}){let n=_(t,M,l=>l._payload),s={type:"evalR",data:{code:e,options:n,shelter:a(this,h)}},o=await a(this,m).request(s);switch(o.payloadType){case"raw":throw new Error("Unexpected payload type returned from evalR");default:return I(a(this,m),o)}}async captureR(e,t={}){let n=_(t,M,l=>l._payload),s={type:"captureR",data:{code:e,options:n,shelter:a(this,h)}},o=await a(this,m).request(s);switch(o.payloadType){case"ptr":throw new Error("Unexpected payload type returned from evalR");case"raw":{let l=o.obj,p=I(a(this,m),l.result),y=l.output;for(let x=0;x<y.length;++x)y[x].type!=="stdout"&&y[x].type!=="stderr"&&(y[x].data=I(a(this,m),y[x].data));return{result:p,output:y}}}}};h=new WeakMap,m=new WeakMap,Se=new WeakMap;function Dr(r){return new Proxy(pt,{construct:async()=>{let e=new pt(r);return await e.init(),e}})}export{St as Console,pt as Shelter,lt as WebR};
//# sourceMappingURL=webr.mjs.map
