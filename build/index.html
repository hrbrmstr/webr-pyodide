<!doctype html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>WebR &amp; Pyodide</title><meta property="og:title" content="WebR &amp; Pyodide"><meta property="twitter:title" content="WebR &amp; Pyodide"><meta property="og:description" content="The Recees Peanut Butter Cup Of The Data Web"><meta property="twitter:description" content="The Recees Peanut Butter Cup Of The Data Web"><meta property="og:site" content="https://rud.is/w/webr-drop"><meta property="og:site_name" content="WebR Exeriments"><meta property="og:image:url" content="https://rud.is/w/webr-drop/img/preview.png"><meta property="og:image:width" content="1536"><meta property="og:image:height" content="768"><meta property="og:image:alt" content="example"><meta property="twitter:site_name" content="@hrbrmstr"><meta property="twitter:domain" content="rud.is"><meta property="twitter:card" content="summary_large_image"><meta property="article:published_time" content="2023-03-30T12:33:05.769Z"><link href="assets/style-429bc5e7.css" rel="stylesheet"></head><body><h1>üß™ WebR &amp; Pyodide</h1><p><status-message id="status"></status-message></p><h2>Hello From Python!</h2><pre id="py-output"></pre><h2>Hello From R!</h2><pre id="r-output"></pre><h2>Yes, I'm Making You Look At a Python Plot <em>(wait for it‚Ä¶)</em></h2><img style="margin-bottom:2rem" id="py-plt-output"><h2>wut?</h2><p>A hearty üëãüèº to all you out there in WebR land!</p><p>While I have some other stuff cooking up, you've likely noticed that ‚Äî even with the <a href="https://rud.is/w/webr-file">previous experiment</a> ‚Äî&nbsp;there are still LOTS of R packages that just will not work in WebR <em>yet</em>!. Please kick the tyres on this <a href="https://observablehq.com/@hrbrmstr/fiddling-with-r-universe-webr">Observable notebook</a> which can help you figure out if it's worth the trouble using the R Universe install "hack" or just wait for the builds to happen. Things are progressing super fast in WebR land!</p><p>Still, our fav pkgs likely are not ready for prime time. Sure, we have SCADS of JS libraries to use, but we're DATA SCIENCE folks who are used to R and (sadly) Python.</p><p>Wait‚Ä¶</p><p>We are used to R AND <em>PYTHON</em>!</p><p>Let's call for aid from our <a href="https://pyodide.org/en/stable/">lesser sibling</a>.</p><p>That's right. You aren't dreaming. We're going to put WebR and Pyodide into the same web app!</p><p>You'll recognize this idiom in <code>py.js</code> since lots of WASM-y things use it. Here, we're loading up Pyodide and making the shrunken <code>pip</code> available to install (ugh) <code>matplotlib</code> (we'll do that in the code block after this one).</p><pre class="shiki" style="background-color:#0b0e14" tabindex="0"><code><span class="line"><span style="color:#ff8f40">import</span><span style="color:#bfbdb6"> </span><span style="color:#d2a6ff">*</span><span style="color:#bfbdb6"> </span><span style="color:#ff8f40">as</span><span style="color:#bfbdb6"> pyodide </span><span style="color:#ff8f40">from</span><span style="color:#bfbdb6"> </span><span style="color:#aad94c">'https://cdn.jsdelivr.net/pyodide/v0.22.1/full/pyodide.mjs'</span></span>
<span class="line"></span>
<span class="line"><span style="color:#bfbdb6">globalThis</span><span style="color:#f29668">.</span><span style="color:#bfbdb6">webPy </span><span style="color:#f29668">=</span><span style="color:#bfbdb6"> </span><span style="color:#ff8f40">await</span><span style="color:#bfbdb6"> pyodide</span><span style="color:#f29668">.</span><span style="color:#ffb454">loadPyodide</span><span style="color:#bfbdb6">({</span></span>
<span class="line"><span style="color:#bfbdb6">	indexURL</span><span style="color:#bfbDB6B3">:</span><span style="color:#bfbdb6"> </span><span style="color:#aad94c">"https://cdn.jsdelivr.net/pyodide/v0.22.1/full/"</span><span style="color:#bfbDB6B3">,</span></span>
<span class="line"><span style="color:#bfbdb6">	fullStdLib</span><span style="color:#bfbDB6B3">:</span><span style="color:#bfbdb6"> </span><span style="color:#d2a6ff">true</span><span style="color:#bfbDB6B3">,</span></span>
<span class="line"><span style="color:#bfbdb6">})</span><span style="color:#bfbDB6B3">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ff8f40">export</span><span style="color:#bfbdb6"> </span><span style="color:#ff8f40">let</span><span style="color:#bfbdb6"> webPy </span><span style="color:#f29668">=</span><span style="color:#bfbdb6"> globalThis</span><span style="color:#f29668">.</span><span style="color:#bfbdb6">webPy</span><span style="color:#bfbDB6B3">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ff8f40">await</span><span style="color:#bfbdb6"> webPy</span><span style="color:#f29668">.</span><span style="color:#ffb454">loadPackage</span><span style="color:#bfbdb6">([ </span><span style="color:#aad94c">"micropip"</span><span style="color:#bfbdb6"> ])</span><span style="color:#bfbDB6B3">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ff8f40">export</span><span style="color:#bfbdb6"> </span><span style="color:#ff8f40">const</span><span style="color:#bfbdb6"> micropip </span><span style="color:#f29668">=</span><span style="color:#bfbdb6"> webPy</span><span style="color:#f29668">.</span><span style="color:#ffb454">pyimport</span><span style="color:#bfbdb6">(</span><span style="color:#aad94c">"micropip"</span><span style="color:#bfbdb6">)</span><span style="color:#bfbDB6B3">;</span></span>
<span class="line"></span></code></pre><p>We need to install some packages from Pyodide's package manager, so we add some bits to <code>main.js</code> (I'm only showing the changed bits):</p><pre class="shiki" style="background-color:#0b0e14" tabindex="0"><code><span class="line"><span style="color:#bfbdb6">message</span><span style="color:#f29668">.</span><span style="color:#bfbdb6">text </span><span style="color:#f29668">=</span><span style="color:#bfbdb6"> </span><span style="color:#aad94c">"Pyodide Loading‚Ä¶"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ff8f40">import</span><span style="color:#bfbdb6"> </span><span style="color:#d2a6ff">*</span><span style="color:#bfbdb6"> </span><span style="color:#ff8f40">as</span><span style="color:#bfbdb6"> Py </span><span style="color:#ff8f40">from</span><span style="color:#bfbdb6"> </span><span style="color:#aad94c">"./py.js"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#acb6BF8C;font-style:italic">// get some info from python. This `runPython` is kind of nice to work with tbh.</span></span>
<span class="line"><span style="color:#ff8f40">const</span><span style="color:#bfbdb6"> res </span><span style="color:#f29668">=</span><span style="color:#bfbdb6"> </span><span style="color:#ff8f40">await</span><span style="color:#bfbdb6"> Py</span><span style="color:#f29668">.</span><span style="color:#bfbdb6">webPy</span><span style="color:#f29668">.</span><span style="color:#ffb454">runPython</span><span style="color:#bfbdb6">(</span><span style="color:#aad94c">`</span></span>
<span class="line"><span style="color:#aad94c">import sys</span></span>
<span class="line"><span style="color:#aad94c">import json</span></span>
<span class="line"><span style="color:#aad94c">json.dumps({ 'version': sys.version, 'executable': sys.executable, 'platform': sys.platform }, indent=2)</span></span>
<span class="line"><span style="color:#aad94c">`</span><span style="color:#bfbdb6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#acb6BF8C;font-style:italic">// display stuffs!</span></span>
<span class="line"><span style="color:#ff8f40">const</span><span style="color:#bfbdb6"> pyOut </span><span style="color:#f29668">=</span><span style="color:#bfbdb6"> document</span><span style="color:#f29668">.</span><span style="color:#ffb454">getElementById</span><span style="color:#bfbdb6">(</span><span style="color:#aad94c">"py-output"</span><span style="color:#bfbdb6">) </span><span style="color:#acb6BF8C;font-style:italic">// placeholder (see below)</span></span>
<span class="line"><span style="color:#bfbdb6">pyOut</span><span style="color:#f29668">.</span><span style="color:#bfbdb6">innerText </span><span style="color:#f29668">=</span><span style="color:#bfbdb6"> res</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ff8f40">const</span><span style="color:#bfbdb6"> rOut </span><span style="color:#f29668">=</span><span style="color:#bfbdb6"> document</span><span style="color:#f29668">.</span><span style="color:#ffb454">getElementById</span><span style="color:#bfbdb6">(</span><span style="color:#aad94c">"r-output"</span><span style="color:#bfbdb6">) </span><span style="color:#acb6BF8C;font-style:italic">// placeholder (see below)</span></span>
<span class="line"><span style="color:#bfbdb6">rOut</span><span style="color:#f29668">.</span><span style="color:#bfbdb6">innerText </span><span style="color:#f29668">=</span><span style="color:#bfbdb6"> </span><span style="color:#ff8f40">await</span><span style="color:#bfbdb6"> webR</span><span style="color:#f29668">.</span><span style="color:#ffb454">evalRString</span><span style="color:#bfbdb6">(</span><span style="color:#aad94c">"R.version.string"</span><span style="color:#bfbdb6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#acb6BF8C;font-style:italic">// I highly suggest opening up DevTools and reloading the page to watch this</span></span>
<span class="line"><span style="color:#bfbdb6">message</span><span style="color:#f29668">.</span><span style="color:#bfbdb6">text </span><span style="color:#f29668">=</span><span style="color:#bfbdb6"> </span><span style="color:#aad94c">"Installing matplotlib"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ff8f40">await</span><span style="color:#bfbdb6"> Py</span><span style="color:#f29668">.</span><span style="color:#bfbdb6">micropip</span><span style="color:#f29668">.</span><span style="color:#ffb454">install</span><span style="color:#bfbdb6">(</span><span style="color:#aad94c">"matplotlib"</span><span style="color:#bfbdb6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#acb6BF8C;font-style:italic">// I need to do some penance for this violation of sanity.</span></span>
<span class="line"><span style="color:#ff8f40">const</span><span style="color:#bfbdb6"> plt </span><span style="color:#f29668">=</span><span style="color:#bfbdb6"> </span><span style="color:#ff8f40">await</span><span style="color:#bfbdb6"> webPy</span><span style="color:#f29668">.</span><span style="color:#ffb454">runPython</span><span style="color:#bfbdb6">(</span><span style="color:#aad94c">`</span></span>
<span class="line"><span style="color:#aad94c">import matplotlib.pyplot as plt</span></span>
<span class="line"><span style="color:#aad94c">import io, base64</span></span>
<span class="line"><span style="color:#aad94c">import numpy as np</span></span>
<span class="line"></span>
<span class="line"><span style="color:#aad94c">y = [0.22, 0.34, 0.5, 0.56, 0.78]</span></span>
<span class="line"><span style="color:#aad94c">x = [0.17, 0.5, 0.855]</span></span>
<span class="line"><span style="color:#aad94c">X, Y = np.meshgrid(x, y)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#aad94c">fig, ax = plt.subplots(figsize=(6, 4), dpi=100)</span></span>
<span class="line"><span style="color:#aad94c">ax.set(xlim=(0, 1), ylim=(0, 1), xticks=[], yticks=[])</span></span>
<span class="line"><span style="color:#aad94c">ax.spines[:].set_visible(False)</span></span>
<span class="line"><span style="color:#aad94c">ax.text(0.5, 0.5, 'plot', fontsize=128, ha='center', va='center', zorder=1)</span></span>
<span class="line"><span style="color:#aad94c">ax.hlines(y, x[0], x[-1], color='grey')</span></span>
<span class="line"><span style="color:#aad94c">ax.vlines(x, y[0], y[-1], color='grey')</span></span>
<span class="line"><span style="color:#aad94c">ax.plot(X.ravel(), Y.ravel(), 'o')</span></span>
<span class="line"><span style="color:#aad94c">pad_x = 0.02</span></span>
<span class="line"><span style="color:#aad94c">pad_y = 0.04</span></span>
<span class="line"><span style="color:#aad94c">ax.text(x[0] - pad_x, y[0], 'bottom', ha='right', va='center')</span></span>
<span class="line"><span style="color:#aad94c">ax.text(x[0] - pad_x, y[1], 'baseline', ha='right', va='center')</span></span>
<span class="line"><span style="color:#aad94c">ax.text(x[0] - pad_x, y[2], 'center', ha='right', va='center')</span></span>
<span class="line"><span style="color:#aad94c">ax.text(x[0] - pad_x, y[3], 'center_baseline', ha='right', va='center')</span></span>
<span class="line"><span style="color:#aad94c">ax.text(x[0] - pad_x, y[4], 'top', ha='right', va='center')</span></span>
<span class="line"><span style="color:#aad94c">ax.text(x[0], y[0] - pad_y, 'left', ha='center', va='top')</span></span>
<span class="line"><span style="color:#aad94c">ax.text(x[1], y[0] - pad_y, 'center', ha='center', va='top')</span></span>
<span class="line"><span style="color:#aad94c">ax.text(x[2], y[0] - pad_y, 'right', ha='center', va='top')</span></span>
<span class="line"><span style="color:#aad94c">ax.set_xlabel('horizontalalignment', fontsize=14)</span></span>
<span class="line"><span style="color:#aad94c">ax.set_ylabel('verticalalignment', fontsize=14, labelpad=35)</span></span>
<span class="line"><span style="color:#aad94c">ax.set_title('Relative position of text anchor point depending on alignment')</span></span>
<span class="line"></span>
<span class="line"><span style="color:#aad94c">buf = io.BytesIO()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#aad94c">fig.savefig(buf, format='png')</span></span>
<span class="line"><span style="color:#aad94c">buf.seek(0)</span></span>
<span class="line"><span style="color:#aad94c">'data:image/png;base64,' + base64.b64encode(buf.read()).decode('UTF-8')</span></span>
<span class="line"><span style="color:#aad94c">`</span><span style="color:#bfbdb6">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#acb6BF8C;font-style:italic">// we get to put that base64 encoded img right into our placeholder (see below)!</span></span>
<span class="line"><span style="color:#ff8f40">const</span><span style="color:#bfbdb6"> pltOut </span><span style="color:#f29668">=</span><span style="color:#bfbdb6"> document</span><span style="color:#f29668">.</span><span style="color:#ffb454">getElementById</span><span style="color:#bfbdb6">(</span><span style="color:#aad94c">"py-plt-output"</span><span style="color:#bfbdb6">) </span></span>
<span class="line"><span style="color:#bfbdb6">pltOut</span><span style="color:#f29668">.</span><span style="color:#bfbdb6">src </span><span style="color:#f29668">=</span><span style="color:#bfbdb6"> plt</span></span>
<span class="line"></span></code></pre><p>The various output bits go in these placeholder elements (foregoing web components for simplicity):</p><pre class="shiki" style="background-color:#0b0e14" tabindex="0"><code><span class="line"><span style="color:#39bAE680">&lt;</span><span style="color:#39bae6">pre</span><span style="color:#bfbdb6"> </span><span style="color:#ffb454">id</span><span style="color:#bfbDB6B3">=</span><span style="color:#aad94c">"py-output"</span><span style="color:#39bAE680">&gt;</span></span>
<span class="line"><span style="color:#39bAE680">&lt;/</span><span style="color:#39bae6">pre</span><span style="color:#39bAE680">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#39bAE680">&lt;</span><span style="color:#39bae6">pre</span><span style="color:#bfbdb6"> </span><span style="color:#ffb454">id</span><span style="color:#bfbDB6B3">=</span><span style="color:#aad94c">"r-output"</span><span style="color:#39bAE680">&gt;</span></span>
<span class="line"><span style="color:#39bAE680">&lt;/</span><span style="color:#39bae6">pre</span><span style="color:#39bAE680">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#39bAE680">&lt;</span><span style="color:#39bae6">img</span><span style="color:#bfbdb6"> </span><span style="color:#ffb454">id</span><span style="color:#bfbDB6B3">=</span><span style="color:#aad94c">"py-plt-output"</span><span style="color:#39bAE680">/&gt;</span></span>
<span class="line"></span></code></pre><h3>FIN</h3><p>There are tons more Python packages that can likely fill in the gap while we patiently wait for WebR to be baked a bit more.</p><p>I'll add some experiments that show how to have Pyodide and WebR talk to each other, but I think most folks who are following along can figure that out without me.</p><p>Source is up <a href="https://github.com/hrbrmstr/webr-pyodide">on GitHub</a>.</p><p style="text-align:center;margin-top:2rem">Brought to you by @hrbrmstr</p><script type="module" src="./main.js"></script></body></html>